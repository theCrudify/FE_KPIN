<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Document Reimbursement</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/detailReim.js"></script>
    <script src="../js/auth.js"></script>
    <!-- Tambahkan script perbaikan -->
    <script src="../js/detailReim-fix.js" defer></script>
    <style>
        /* Dropdown styling */
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        .search-dropdown {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
        }
        .search-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        /* Error message styling */
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen bg-gradient-to-r from-blue-500 to-red-500">
    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-6xl">
        <!-- Error Message Container -->
        <div id="errorContainer" class="error-message hidden">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorMessage">An error occurred while loading the page.</span>
            </div>
        </div>
        
        <!-- Loading Container -->
        <div id="loadingContainer" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Loading reimbursement data...</p>
        </div>
        
        <!-- Main Content Container -->
        <div id="mainContent" class="hidden">
            <button onclick="goToMenuReim()" type="button" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 shadow transition transform hover:scale-105 duration-200 w-32">Back</button>
            <h2 class="text-2xl font-bold text-center text-blue-900 mb-4">Detail Document Reimbursement</h2>
            <br>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-semibold mb-2">Voucher No</h3>
                    <input type="text" id="voucherNo" placeholder="Voucher no" class="w-full p-2 border rounded" disabled>

                    <h3 class="text-lg font-semibold mb-2">Requester Name</h3>
                    <div class="relative">
                        <input type="text" id="requesterNameSearch" placeholder="Search name..." class="w-full p-2 border rounded search-input">
                        <div id="requesterNameSelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                        <select id="requesterNameSelect" class="hidden">
                            <option value="" disabled selected>Choose Name</option>
                        </select>
                    </div>

                    <h3 class="text-lg font-semibold mb-2">Department</h3>
                    <select id="department" class="w-full p-2 border rounded">
                        <option value="" disabled selected>Select Department</option>
                    </select>

                    <h3 class="text-lg font-semibold mb-2">Currency</h3>
                    <select id="currency" class="w-full p-2 border rounded" required autocomplete="off">
                        <option value="" disabled selected>Select Currency</option>
                        <option value="IDR">IDR</option>
                        <option value="USD">USD</option>
                        <option value="SGD">SGD</option>
                        <option value="EUR">EUR</option>
                        <option value="JPY">JPY</option>
                        <option value="GBP">GBP</option>
                        <option value="AUD">AUD</option>
                        <option value="CAD">CAD</option>
                        <option value="CHF">CHF</option>
                    </select>

                    <h3 class="text-lg font-semibold mb-2">Pay To</h3>
                    <div class="relative">
                        <input type="text" id="payToSearch" placeholder="Search user..." class="w-full p-2 border rounded search-input">
                        <div id="payToSelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                        <select id="payToSelect" class="hidden">
                            <option value="" disabled selected>Choose User</option>
                        </select>
                    </div>        
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-2">Submission Date</h3>
                    <input type="date" id="submissionDate" class="w-full p-2 border rounded">

                    <h3 class="text-lg font-semibold mb-2">Status</h3>
                    <select id="status" class="w-full p-2 border rounded" disabled>
                        <option value="Draft">Draft</option>
                        <option value="Prepared">Prepared</option>
                        <option value="Acknowledged">Acknowledged</option>
                        <option value="Checked">Checked</option>
                        <option value="Approved">Approved</option>
                        <option value="Received">Received</option>
                        <option value="Paid">Paid</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Revised">Revision</option>
                    </select>

                    <!-- Input untuk upload attachment - hanya file PDF yang diperbolehkan -->
                    <h3 class="text-lg font-semibold mb-2">Attach Doc</h3>
                    <input type="file" id="filePath" accept="application/pdf" class="w-full p-2 border rounded" multiple onchange="previewPDF(event)" />
                    <p class="text-sm text-gray-600 mt-1">Hanya file PDF yang diperbolehkan</p>
                    <!-- Container untuk menampilkan daftar attachment dengan tombol View dan Delete -->
                    <div id="attachmentsList" class="mt-2"></div>
                    
                    <h3 class="text-lg font-semibold mb-2">Reference Doc</h3>
                    <input type="text" id="referenceDoc" placeholder="No.Invoice" class="w-full p-2 border rounded">

                    <h3 class="text-lg font-semibold mb-2">Type of Transaction</h3>
                    <select id="typeOfTransaction" class="w-full p-2 border rounded">
                        <option value="" disabled selected>Select Transaction Type</option>
                        <!-- Options will be populated from API -->
                    </select>
                </div>
            </div>
            
            <table id="reimTable" class="w-full text-left border mt-2"> <!-- ini dari reimbursementDetails-->
                <thead class="bg-gray-100">
                    <br>
                    <tr>
                        <th class="p-2">Category</th>
                        <th class="p-2">Account Name</th>
                        <th class="p-2">G/L Account</th>
                        <th class="p-2">Description</th>
                        <th class="p-2">Amount</th>
                        <th class="p-2">Action</th>
                    </tr>
                </thead>
                <tbody id="reimbursementDetails">
                    <!-- Rows will be added dynamically -->
                </tbody>
            </table>
            
            <!-- Total Amount Container -->
            <div class="total-amount-container flex justify-end mt-4">
                <div class="w-1/3">
                    <div class="flex items-center">
                        <label class="font-semibold text-lg mr-4">Total Amount:</label>
                        <input type="text" id="totalAmount" class="w-full p-2 border rounded bg-gray-100 font-semibold text-right" readonly>
                    </div>
                </div>
            </div>
            
            <!-- Tombol Tambah Baris -->
            <button onclick="addRow()" class="mt-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                + 
            </button>

                <div class="mt-4">
                  <label>Remarks</label>
                  <textarea id="remarks" class="w-full p-2 border rounded-md"></textarea>
                </div>

                <!-- Revised Remarks Display Section (Read-only) -->
                <div class="mt-4" id="revisedRemarksSection" style="display: none;">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Revision History</h3>
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="mb-2">
                            <span class="text-sm font-medium text-gray-600">Total Revisions: </span>
                            <span id="revisedCount" class="text-sm font-bold text-blue-600">0</span>
                        </div>
                        
                        <!-- First Revision Remarks -->
                        <div id="firstRevisionContainer" class="mb-3" style="display: none;">
                            <label class="text-sm font-medium text-gray-700">First Revision:</label>
                            <div id="firstRevisionRemarks" class="w-full p-2 border rounded-md bg-white text-sm text-gray-800 min-h-[60px] whitespace-pre-wrap"></div>
                        </div>
                        
                        <!-- Second Revision Remarks -->
                        <div id="secondRevisionContainer" class="mb-3" style="display: none;">
                            <label class="text-sm font-medium text-gray-700">Second Revision:</label>
                            <div id="secondRevisionRemarks" class="w-full p-2 border rounded-md bg-white text-sm text-gray-800 min-h-[60px] whitespace-pre-wrap"></div>
                        </div>
                        
                        <!-- Third Revision Remarks -->
                        <div id="thirdRevisionContainer" class="mb-3" style="display: none;">
                            <label class="text-sm font-medium text-gray-700">Third Revision:</label>
                            <div id="thirdRevisionRemarks" class="w-full p-2 border rounded-md bg-white text-sm text-gray-800 min-h-[60px] whitespace-pre-wrap"></div>
                        </div>
                        
                        <!-- Fourth Revision Remarks -->
                        <div id="fourthRevisionContainer" class="mb-3" style="display: none;">
                            <label class="text-sm font-medium text-gray-700">Fourth Revision:</label>
                            <div id="fourthRevisionRemarks" class="w-full p-2 border rounded-md bg-white text-sm text-gray-800 min-h-[60px] whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>

                <!-- Rejection Remarks Display Section -->
                <div class="mt-4" id="rejectionRemarksSection" style="display: none;">
                    <h3 class="text-lg font-semibold mb-2 text-red-600">Rejection Remarks</h3>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <textarea id="rejectionRemarks" class="w-full p-2 border rounded-md bg-white text-sm text-gray-800 min-h-[60px] whitespace-pre-wrap" readonly></textarea>
                    </div>
                </div>

            <!-- Approval section -->
            <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                <div> 
                    <label id="preparedBy" class="mr-1"><strong>Prepared by :</strong></label>
                    <div class="relative">
                        <input type="text" id="preparedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input">
                        <div id="preparedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                        <select id="preparedBySelect" class="hidden">
                            <option value="" disabled selected>Choose Name</option>
                        </select>
                    </div>
                </div>
                <div>
                <label id="acknowledgeBy" class="mr-1"><strong>Acknowledge by :</strong></label>
                    <div class="relative">
                        <input type="text" id="acknowledgeBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input">
                        <div id="acknowledgeBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                        <select id="acknowledgeBySelect" class="hidden">
                            <option value="" disabled selected>Choose Name</option>
                        </select>
                    </div>
                </div>
                <div>
                <label id="checkedBy" class="mr-1"><strong>Checked by :</strong></label>
                    <div class="relative">
                        <input type="text" id="checkedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input">
                        <div id="checkedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                        <select id="checkedBySelect" class="hidden">
                            <option value="" disabled selected>Choose Name</option>
                        </select>
                    </div>
                </div>
                <div>
                <label id="approvedBy" class="mr-1"><strong>Approved by :</strong></label>
                    <div class="relative">
                        <input type="text" id="approvedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input">
                        <div id="approvedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                        <select id="approvedBySelect" class="hidden">
                            <option value="" disabled selected>Choose Name</option>
                        </select>
                    </div>
                </div>
                <div>
                <label id="receivedBy" class="mr-1"><strong>Received by :</strong></label>
                    <div class="relative">
                        <input type="text" id="receivedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input">
                        <div id="receivedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                        <select id="receivedBySelect" class="hidden">
                            <option value="" disabled selected>Choose Name</option>
                        </select>
                    </div>
                </div>
            </div>
            <br>
            <div class="flex justify-start space-x-4 mt-6">
                <button onclick="confirmDelete()" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 px-2 rounded-lg shadow transition transform hover:scale-105 duration-200 w-32">
                    Delete
                </button> <!-- ID : nanti get ID dari url parameter-->

                <button onclick="updateReim()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-2 rounded-lg shadow transition transform hover:scale-105 duration-200 w-32">
                    Update
                </button>
                
                <button onclick="confirmSubmit()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-2 rounded-lg shadow transition transform hover:scale-105 duration-200 w-32">
                    Submit
                </button>
            </div>
        </div>
    </div>
    
    <script>
    // Show/hide containers based on loading state
    function showLoading() {
        document.getElementById('loadingContainer').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('errorContainer').classList.add('hidden');
    }
    
    function showMainContent() {
        document.getElementById('loadingContainer').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        document.getElementById('errorContainer').classList.add('hidden');
    }
    
    function showError(message) {
        document.getElementById('loadingContainer').classList.add('hidden');
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('errorContainer').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = message;
    }
    
    // Initialize page state
    document.addEventListener('DOMContentLoaded', function() {
        showLoading();
        
        // Check if we have a valid reimbursement ID
        const urlParams = new URLSearchParams(window.location.search);
        const reimId = urlParams.get('reim-id');
        
        if (!reimId) {
            showError('No reimbursement ID found in URL. Please go back and try again.');
            return;
        }
        
        // Check if BASE_URL is available
        if (typeof BASE_URL === 'undefined' || !BASE_URL) {
            showError('Application configuration is invalid. Please contact administrator.');
            return;
        }
        
        // Check authentication
        if (typeof isAuthenticated === 'function' && !isAuthenticated()) {
            showError('Authentication required. Please login again.');
            setTimeout(() => {
                if (typeof logoutAuth === 'function') {
                    logoutAuth();
                } else {
                    localStorage.clear();
                    window.location.href = '../pages/login.html';
                }
            }, 2000);
            return;
        }
        
        // If all checks pass, show main content
        showMainContent();
        
        // Initialize currency formatting for existing inputs
        setTimeout(() => {
            const existingInputs = document.querySelectorAll('.currency-input-idr');
            existingInputs.forEach(input => {
                input.removeAttribute('maxlength');
                input.setAttribute('autocomplete', 'off');
                
                // Format existing values
                if (input.value) {
                    formatCurrencyInputIDR(input);
                } else {
                    input.value = '0.00';
                }
            });
            
            // Update total amount
            if (typeof updateTotalAmount === 'function') {
                updateTotalAmount();
            }
        }, 1000);
    });
    </script>
    <script>
    // Fungsi untuk memformat angka dengan format Indonesia (titik sebagai pemisah ribuan, koma sebagai pemisah desimal)
    function formatCurrencyIDR(number) {
        // Handle input kosong atau tidak valid
        if (number === null || number === undefined || number === '') {
            return '0.00';
        }
        
        // Parse angka, pastikan dapat menangani nilai yang sangat besar
        let num;
        try {
            // Handle input string yang mungkin sangat besar
            if (typeof number === 'string') {
                // Hapus semua karakter non-numerik kecuali titik desimal dan koma
                const cleanedStr = number.replace(/[^\d,.]/g, '');
                // Gunakan parseFloat untuk angka kecil, dan untuk angka besar gunakan teknik string
                if (cleanedStr.length > 15) {
                    // Untuk angka yang sangat besar, kita perlu menangani dengan hati-hati
                    // Hapus koma dan parse
                    num = Number(cleanedStr.replace(/,/g, ''));
                } else {
                    num = parseFloat(cleanedStr.replace(/,/g, ''));
                }
            } else {
                num = Number(number); // Gunakan Number untuk menangani angka besar dengan lebih baik
            }
            
            // Jika parsing gagal, kembalikan string kosong
            if (isNaN(num)) {
                return '0.00';
            }
        } catch (e) {
            console.error('Error parsing number:', e);
            return '0.00';
        }
        
        // Batasi maksimum 100 triliun
        const maxAmount = 100000000000000; // 100 triliun
        if (num > maxAmount) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Amount Exceeds Limit',
                    text: 'Total amount must not exceed 100 trillion rupiah'
                });
            } else {
                alert('Total amount must not exceed 100 trillion rupiah');
            }
            num = maxAmount;
        }
        
        // Format dengan format US (koma sebagai pemisah ribuan, titik sebagai pemisah desimal)
        // Untuk angka yang sangat besar, gunakan metode manual
        if (num >= 1e12) { // Jika angka >= 1 triliun
            let strNum = num.toString();
            let result = '';
            let count = 0;
            
            // Tambahkan koma setiap 3 digit dari belakang
            for (let i = strNum.length - 1; i >= 0; i--) {
                result = strNum[i] + result;
                count++;
                if (count % 3 === 0 && i > 0) {
                    result = ',' + result;
                }
            }
            
            // Tambahkan 2 desimal
            return result + '.00';
        } else {
            // Untuk angka yang lebih kecil, gunakan toLocaleString
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    }

    // Fungsi untuk mengurai format angka US kembali ke angka
    function parseCurrencyIDR(formattedValue) {
        if (!formattedValue) return 0;
        
        try {
            // Tangani format US (pemisah ribuan: ',', pemisah desimal: '.')
            // Hapus koma (pemisah ribuan)
            const numericValue = formattedValue.toString().replace(/,/g, '');
            
            return parseFloat(numericValue) || 0;
        } catch (e) {
            console.error('Error parsing currency:', e);
            return 0;
        }
    }

    // Fungsi untuk memformat input nilai mata uang saat pengguna mengetik
    function formatCurrencyInputIDR(input) {
        // Simpan posisi kursor
        const cursorPos = input.selectionStart;
        const originalLength = input.value.length;
        
        // Ambil nilai dan hapus semua karakter non-digit, titik dan koma
        let value = input.value.replace(/[^\d,.]/g, '');
        
        // Pastikan hanya ada satu pemisah desimal
        let parts = value.split('.');
        if (parts.length > 1) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Hapus batasan 10 digit
        // Tidak ada batasan panjang digit di sini
        
        // Parse nilai ke angka untuk perhitungan
        const numValue = parseCurrencyIDR(value);
        
        // Format dengan format US
        const formattedValue = formatCurrencyIDR(numValue);
        
        // Perbarui nilai input
        input.value = formattedValue;
        
        // Hitung dan perbarui total
        if (typeof updateTotalAmount === 'function') {
            updateTotalAmount();
        }
        
        // Sesuaikan posisi kursor
        const newLength = input.value.length;
        const newCursorPos = cursorPos + (newLength - originalLength);
        input.setSelectionRange(Math.max(0, newCursorPos), Math.max(0, newCursorPos));
    }

    // Fungsi untuk menghitung total amount dari semua baris
    function updateTotalAmount() {
        const amountInputs = document.querySelectorAll('#reimbursementDetails tr td:nth-child(5) input');
        let total = 0;
        
        amountInputs.forEach(input => {
            // Ekstrak nilai numerik dari input
            const amountText = input.value.trim();
            // Konversi dari format US ke format standar untuk perhitungan
            const numericValue = parseCurrencyIDR(amountText);
            total += numericValue;
        });
        
        // Periksa jika total melebihi 100 triliun
        const maxAmount = 100000000000000; // 100 triliun
        if (total > maxAmount) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Amount Exceeds Limit',
                    text: 'Total amount must not exceed 100 trillion rupiah'
                });
            } else {
                alert('Total amount must not exceed 100 trillion rupiah');
            }
            total = maxAmount;
        }
        
        // Format total dengan format US dan tampilkan
        const formattedTotal = formatCurrencyIDR(total);
        
        // Perbarui nilai total
        const totalAmountInput = document.getElementById('totalAmount');
        if (totalAmountInput) {
            totalAmountInput.value = formattedTotal;
        }
    }

    // Modifikasi fungsi addRow untuk menggunakan format US
    function modifyAddRowForIDR() {
        const originalAddRow = window.addRow;
        
        window.addRow = function() {
            originalAddRow();
            
            // Ambil baris terakhir yang baru ditambahkan
            const tableBody = document.getElementById('reimbursementDetails');
            const newRow = tableBody.lastElementChild;
            
            // Ubah input untuk format IDR
            const amountInput = newRow.querySelector('td:nth-child(5) input');
            if (amountInput) {
                amountInput.type = 'text';
                amountInput.classList.add('currency-input-idr');
                amountInput.removeAttribute('maxlength'); // Hapus batasan maxlength jika ada
                amountInput.value = '0.00'; // Set nilai default
                amountInput.addEventListener('input', function() {
                    formatCurrencyInputIDR(this);
                });
                amountInput.setAttribute('autocomplete', 'off'); // Tambahkan autocomplete="off"
            }
        };
        
        // Ubah semua baris yang sudah ada
        const existingRows = document.querySelectorAll('#reimbursementDetails tr');
        existingRows.forEach(row => {
            const amountInput = row.querySelector('td:nth-child(5) input');
            if (amountInput) {
                amountInput.type = 'text';
                amountInput.classList.add('currency-input-idr');
                amountInput.removeAttribute('maxlength'); // Hapus batasan maxlength
                amountInput.addEventListener('input', function() {
                    formatCurrencyInputIDR(this);
                });
                amountInput.setAttribute('autocomplete', 'off'); // Tambahkan autocomplete="off"
                
                // Format nilai awal jika ada
                if (amountInput.value) {
                    formatCurrencyInputIDR(amountInput);
                } else {
                    amountInput.value = '0.00'; // Set nilai default jika kosong
                }
            }
        });
        
        // Inisialisasi total amount
        updateTotalAmount();
    }

    // Jalankan modifikasi setelah dokumen dimuat
    document.addEventListener('DOMContentLoaded', function() {
        // Hapus batasan maxlength dari input yang sudah ada
        const existingInputs = document.querySelectorAll('.currency-input-idr');
        existingInputs.forEach(input => {
            input.removeAttribute('maxlength');
            input.setAttribute('autocomplete', 'off'); // Tambahkan autocomplete="off"
            // Pastikan input memiliki nilai default
            if (!input.value) {
                input.value = '0.00';
            }
        });
        
        setTimeout(modifyAddRowForIDR, 500); // Delay sedikit untuk memastikan JS lain sudah dimuat
        
        // Inisialisasi total amount segera setelah halaman dimuat
        setTimeout(updateTotalAmount, 600);
        
        // Log untuk debugging
        console.log('Currency formatter initialized for detailReim');
        
        // Override addRow function to ensure proper formatting
        const originalAddRow = window.addRow;
        if (originalAddRow) {
            window.addRow = function() {
                originalAddRow();
                
                // Get the last added row
                const tableBody = document.getElementById('reimbursementDetails');
                const newRow = tableBody.lastElementChild;
                
                // Format the amount input in the new row
                const amountInput = newRow.querySelector('td:nth-child(5) input');
                if (amountInput) {
                    amountInput.type = 'text';
                    amountInput.classList.add('currency-input-idr');
                    amountInput.removeAttribute('maxlength');
                    amountInput.setAttribute('autocomplete', 'off');
                    amountInput.value = '0.00';
                    amountInput.addEventListener('input', function() {
                        formatCurrencyInputIDR(this);
                    });
                }
                
                // Update total amount
                if (typeof updateTotalAmount === 'function') {
                    updateTotalAmount();
                }
            };
        }
        
        // Override populateReimbursementDetails to ensure proper formatting
        const originalPopulateReimbursementDetails = window.populateReimbursementDetails;
        if (originalPopulateReimbursementDetails) {
            window.populateReimbursementDetails = function(details) {
                originalPopulateReimbursementDetails(details);
                
                // Format all amount inputs after populating
                setTimeout(() => {
                    const amountInputs = document.querySelectorAll('#reimbursementDetails tr td:nth-child(5) input');
                    amountInputs.forEach(input => {
                        input.type = 'text';
                        input.classList.add('currency-input-idr');
                        input.removeAttribute('maxlength');
                        input.setAttribute('autocomplete', 'off');
                        input.addEventListener('input', function() {
                            formatCurrencyInputIDR(this);
                        });
                        
                        // Format existing values
                        if (input.value) {
                            formatCurrencyInputIDR(input);
                        } else {
                            input.value = '0.00';
                        }
                    });
                    
                    // Update total amount
                    if (typeof updateTotalAmount === 'function') {
                        updateTotalAmount();
                    }
                }, 100);
            };
        }
        
        // Override updateTotalAmount to ensure proper formatting
        const originalUpdateTotalAmount = window.updateTotalAmount;
        if (originalUpdateTotalAmount) {
            window.updateTotalAmount = function() {
                originalUpdateTotalAmount();
                
                // Ensure total amount is properly formatted
                const totalAmountInput = document.getElementById('totalAmount');
                if (totalAmountInput && totalAmountInput.value) {
                    const formattedTotal = formatCurrencyIDR(parseCurrencyIDR(totalAmountInput.value));
                    totalAmountInput.value = formattedTotal;
                }
            };
        }
        
        // Add event listeners to all currency inputs
        function addCurrencyEventListeners() {
            const currencyInputs = document.querySelectorAll('.currency-input-idr');
            currencyInputs.forEach(input => {
                // Remove existing event listeners to avoid duplicates
                input.removeEventListener('input', formatCurrencyInputIDR);
                input.removeEventListener('blur', formatCurrencyInputIDR);
                
                // Add new event listeners
                input.addEventListener('input', function() {
                    formatCurrencyInputIDR(this);
                });
                input.addEventListener('blur', function() {
                    formatCurrencyInputIDR(this);
                });
                
                // Ensure input has proper attributes
                input.type = 'text';
                input.removeAttribute('maxlength');
                input.setAttribute('autocomplete', 'off');
                
                // Set default value if empty
                if (!input.value || input.value === '0' || input.value === '0.0') {
                    input.value = '0.00';
                }
            });
        }
        
        // Call addCurrencyEventListeners after a delay to ensure all elements are loaded
        setTimeout(addCurrencyEventListeners, 2000);
        
        // Also call it whenever the DOM changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.target.id === 'reimbursementDetails') {
                    setTimeout(addCurrencyEventListeners, 100);
                }
            });
        });
        
        const reimbursementDetails = document.getElementById('reimbursementDetails');
        if (reimbursementDetails) {
            observer.observe(reimbursementDetails, { childList: true });
        }
        
        // Format all existing currency inputs on page load
        setTimeout(() => {
            const allCurrencyInputs = document.querySelectorAll('input[class*="currency-input-idr"]');
            allCurrencyInputs.forEach(input => {
                // Format the value
                if (input.value) {
                    formatCurrencyInputIDR(input);
                } else {
                    input.value = '0.00';
                }
            });
            
            // Update total amount
            if (typeof updateTotalAmount === 'function') {
                updateTotalAmount();
            }
        }, 3000);
        
        // Override fetchReimbursementData to ensure proper formatting after data load
        const originalFetchReimbursementData = window.fetchReimbursementData;
        if (originalFetchReimbursementData) {
            window.fetchReimbursementData = async function() {
                await originalFetchReimbursementData();
                
                // Format all currency inputs after data is loaded
                setTimeout(() => {
                    const allCurrencyInputs = document.querySelectorAll('input[class*="currency-input-idr"]');
                    allCurrencyInputs.forEach(input => {
                        // Format the value
                        if (input.value) {
                            formatCurrencyInputIDR(input);
                        } else {
                            input.value = '0.00';
                        }
                    });
                    
                    // Update total amount
                    if (typeof updateTotalAmount === 'function') {
                        updateTotalAmount();
                    }
                }, 500);
            };
        }
        
        // Override populateFormData to ensure proper formatting after form data is populated
        const originalPopulateFormData = window.populateFormData;
        if (originalPopulateFormData) {
            window.populateFormData = function(data) {
                originalPopulateFormData(data);
                
                // Format all currency inputs after form data is populated
                setTimeout(() => {
                    const allCurrencyInputs = document.querySelectorAll('input[class*="currency-input-idr"]');
                    allCurrencyInputs.forEach(input => {
                        // Format the value
                        if (input.value) {
                            formatCurrencyInputIDR(input);
                        } else {
                            input.value = '0.00';
                        }
                    });
                    
                    // Update total amount
                    if (typeof updateTotalAmount === 'function') {
                        updateTotalAmount();
                    }
                }, 500);
            };
        }
        
        // Override submitReimbursementUpdate to ensure proper formatting before submission
        const originalSubmitReimbursementUpdate = window.submitReimbursementUpdate;
        if (originalSubmitReimbursementUpdate) {
            window.submitReimbursementUpdate = async function() {
                // Format all currency inputs before submission
                const allCurrencyInputs = document.querySelectorAll('input[class*="currency-input-idr"]');
                allCurrencyInputs.forEach(input => {
                    if (input.value) {
                        formatCurrencyInputIDR(input);
                    }
                });
                
                return await originalSubmitReimbursementUpdate();
            };
        }
        
        // Override submitNewReimbursementDetails to ensure proper formatting before submission
        const originalSubmitNewReimbursementDetails = window.submitNewReimbursementDetails;
        if (originalSubmitNewReimbursementDetails) {
            window.submitNewReimbursementDetails = async function() {
                // Format all currency inputs before submission
                const allCurrencyInputs = document.querySelectorAll('input[class*="currency-input-idr"]');
                allCurrencyInputs.forEach(input => {
                    if (input.value) {
                        formatCurrencyInputIDR(input);
                    }
                });
                
                return await originalSubmitNewReimbursementDetails();
            };
        }
    });
    </script>
</body>
</html>
