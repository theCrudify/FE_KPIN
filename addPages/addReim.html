<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Document Reimbursement</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Dropdown styling */
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        .search-dropdown {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
        }
        .search-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* Styling untuk validasi tanggal */
        .border-red-500 {
            border-color: #ef4444 !important;
        }
        
        #dateError {
            transition: all 0.3s ease;
        }
        
        #dateError:not(.hidden) {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .text-green-500 {
            color: #10b981;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen bg-gradient-to-r from-blue-500 to-red-500">
    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-6xl">
        <button onclick="goToMenuReim()" type="button" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 shadow transition transform hover:scale-105 duration-200 w-32">Back</button>
        <h2 class="text-2xl font-bold text-center text-blue-900 mb-4">Add Reimbursement</h2>
        <br>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <h3 class="text-lg font-semibold mb-2">Voucher No</h3>
                <input type="text" id="voucherNo" placeholder="Voucher no" class="w-full p-2 border rounded bg-gray-100 text-gray-500" disabled autocomplete="off">
                
                <h3 class="text-lg font-semibold mb-2">Requester Name <span class="text-red-500">*</span></h3>
                <div class="relative">
                    <input type="text" id="requesterNameSearch" placeholder="Search name..." class="w-full p-2 border rounded search-input" required autocomplete="off">
                    <div id="requesterNameSelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                    <select id="requesterNameSelect" class="hidden" autocomplete="off">
                        <option value="" disabled selected>Choose Name</option>
                    </select>
                </div>
                
                <h3 class="text-lg font-semibold mb-2">Department</h3>
                <select id="department" class="w-full p-2 border rounded" autocomplete="off">
                    <option value="" disabled selected>Select Department</option>
                </select>
                <h3 class="text-lg font-semibold mb-2">Currency <span class="text-red-500">*</span></h3>
                <select id="currency" class="w-full p-2 border rounded" required autocomplete="off">
                    <option value="" disabled selected>Select Currency</option>
                    <option value="IDR">IDR</option>
                    <option value="USD">USD</option>
                    <option value="SGD">SGD</option>
                    <option value="EUR">EUR</option>
                    <option value="JPY">JPY</option>
                    <option value="GBP">GBP</option>
                    <option value="AUD">AUD</option>
                    <option value="CAD">CAD</option>
                    <option value="CHF">CHF</option>
                </select>
                
                <h3 class="text-lg font-semibold mb-2">Pay To <span class="text-red-500">*</span></h3>
                <div class="relative">
                    <input type="text" id="payToSearch" placeholder="Search user..." class="w-full p-2 border rounded search-input" required autocomplete="off">
                    <div id="payToSelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                    <select id="payToSelect" class="hidden" autocomplete="off">
                        <option value="" disabled selected>Choose User</option>
                    </select>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold mb-2">Submission Date <span class="text-red-500">*</span></h3>
                <input type="date" id="postingDate" class="w-full p-2 border rounded" onchange="validateSubmissionDate(this)" required autocomplete="off" min="" max="" />
                <div id="dateError" class="text-red-500 text-sm mt-1 hidden"></div>
                <h3 class="text-lg font-semibold mb-2">Status</h3>
                <select id="status" class="w-full p-2 border rounded" autocomplete="off">
                    <option value="Draft">Draft</option>
                    <!-- <option value="Closed">Approved</option>
                    <option value="Paid">Paid</option> -->
                </select>
                <h3 class="text-lg font-semibold mb-2">Attach Doc <span class="text-red-500">*</span></h3>
                <input type="file" id="filePath" accept="application/pdf" class="wa-full p-2 border rounded" multiple onchange="previewPDF(event)" required autocomplete="off" />
                <div id="fileList" class="mt-2"></div>
                
                <h3 class="text-lg font-semibold mb-2">Reference Doc <span class="text-red-500">*</span></h3>
                <input type="text" id="referenceDoc" placeholder="No.Invoice" class="w-full p-2 border rounded" required autocomplete="off">
                
                <h3 class="text-lg font-semibold mb-2">Type of Transaction <span class="text-red-500">*</span></h3>
                <select id="typeOfTransaction" class="w-full p-2 border rounded" required autocomplete="off">
                    <option value="" disabled selected>Select Transaction Type</option>
                    <!-- Options will be populated from API -->
                </select>
            </div>
        </div>
        
        <table id="reimTable" class="w-full text-left border mt-2">
            <thead class="bg-gray-100">
                <br>
                <tr>
                    <th class="p-2">Category <span class="text-red-500">*</span></th>
                    <th class="p-2">Account Name <span class="text-red-500">*</span></th>
                    <th class="p-2">G/L Account</th>
                    <th class="p-2">Description <span class="text-red-500">*</span></th>
                    <th class="p-2">Amount <span class="text-red-500">*</span></th>
                    <th class="p-2">Action</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td class="p-2 border">
                        <div class="relative">
                            <input type="text" placeholder="Search category..." class="w-full p-1 border rounded search-input category-search" required autocomplete="off" />
                            <div class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden category-dropdown"></div>
                            <select class="hidden category-select" autocomplete="off">
                                <option value="" disabled selected>Choose Category</option>
                            </select>
                        </div>
                    </td>
                    <td class="p-2 border">
                        <div class="relative">
                            <input type="text" placeholder="Search account name..." class="w-full p-1 border rounded search-input account-name-search" required autocomplete="off" />
                            <div class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden account-name-dropdown"></div>
                            <select class="hidden account-name-select" autocomplete="off">
                                <option value="" disabled selected>Choose Account Name</option>
                            </select>
                        </div>
                    </td>
                    <td class="p-2 border">
                        <input type="text" class="w-full p-1 border rounded bg-gray-200 cursor-not-allowed gl-account" disabled autocomplete="off" />
                    </td>
                    <td class="p-2 border">
                        <input type="text" maxlength="200" class="w-full p-1 border rounded" required autocomplete="off" />
                    </td>
                    <td class="p-2 border">
                    <input type="text" value="0.00" class="w-full p-1 border rounded currency-input-idr" oninput="formatCurrencyInputIDR(this)" required autocomplete="off" />
                    </td>
                    <td class="p-2 border text-center">
                        <button type="button" onclick="deleteRow(this)" class="text-red-500 hover:text-red-700">
                            ðŸ—‘
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <!-- Tombol Tambah Baris -->
        <button onclick="addRow()" class="mt-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-700">
            + 
        </button>

            <div class="mt-4">
              <label>Remarks</label>
              <textarea id="remarks" class="w-full p-2 border rounded-md" autocomplete="off"></textarea>
            </div>

        <!-- Approval section -->
        <div class="grid grid-cols-2 gap-4 text-sm mt-4">
            <div> 
                <label id="preparedBy" class="mr-1"><strong>Prepared by :</strong></label>
                <div class="relative">
                    <input type="text" id="preparedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input" autocomplete="off">
                    <div id="preparedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                    <select id="preparedBySelect" class="hidden" autocomplete="off">
                        <option value="" disabled selected>Choose Name</option>
                    </select>
                </div>
            </div>
            <div>
                <label id="acknowledgeBy" class="mr-1"><strong>Acknowledge by :</strong></label>
                <div class="relative">
                    <input type="text" id="acknowledgeBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input" autocomplete="off">
                    <div id="acknowledgeBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                    <select id="acknowledgeBySelect" class="hidden" autocomplete="off">
                        <option value="" disabled selected>Choose Name</option>
                    </select>
                </div>
            </div>
            <div>
                <label id="checkedBy" class="mr-1"><strong>Checked by :</strong></label>
                <div class="relative">
                    <input type="text" id="checkedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input" autocomplete="off">
                    <div id="checkedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                    <select id="checkedBySelect" class="hidden" autocomplete="off">
                        <option value="" disabled selected>Choose Name</option>
                    </select>
                </div>
            </div>
            <div>
                <label id="approvedBy" class="mr-1"><strong>Approved by :</strong></label>
                <div class="relative">
                    <input type="text" id="approvedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input" autocomplete="off">
                    <div id="approvedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                    <select id="approvedBySelect" class="hidden" autocomplete="off">
                        <option value="" disabled selected>Choose Name</option>
                    </select>
                </div>
            </div>
            <div>
                <label id="receivedBy" class="mr-1"><strong>Received by :</strong></label>
                <div class="relative">
                    <input type="text" id="receivedBySearch" placeholder="Search name..." class="w-full p-2 border rounded search-input" autocomplete="off">
                    <div id="receivedBySelectDropdown" class="absolute left-0 right-0 mt-1 bg-white border rounded search-dropdown hidden"></div>
                    <select id="receivedBySelect" class="hidden" autocomplete="off">
                        <option value="" disabled selected>Choose Name</option>
                    </select>
                </div>
            </div>
        </div>
        <br>
<div class="flex justify-start space-x-4 mt-6">
    <button onclick="saveDocument()" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 px-2 rounded-lg shadow transition transform hover:scale-105 duration-200 w-32">
        Save
    </button>
    <button onclick="submitDocument()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-2 rounded-lg shadow transition transform hover:scale-105 duration-200 w-32">
        Submit
    </button>
</div>
    </div>
    <script src="../js/dateUtils.js"></script>
    <script src="../js/addReim.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/dateValidation.js"></script>
    <script src="../js/formValidation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
    // Modifikasi fungsi saveDocument dan submitDocument untuk menambahkan validasi tanggal dan form
    const originalSaveDocument = window.saveDocument;
    window.saveDocument = function() {
        // Reset field highlights terlebih dahulu
        resetFieldHighlights();
        
        // Validasi tanggal submission
        const postingDateInput = document.getElementById("postingDate");
        if (!validateSubmissionDate(postingDateInput)) {
            Swal.fire({
                icon: 'error',
                title: 'Submission Date not valid',
                text: 'Please select today\'s date only. Past or future dates are not allowed.',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Validasi form reimbursement
        if (!validateReimbursementForm()) {
            return;
        }
        
        // Jika semua validasi lolos, panggil fungsi save asli
        originalSaveDocument();
    };

    const originalSubmitDocument = window.submitDocument;
    window.submitDocument = function() {
        // Reset field highlights terlebih dahulu
        resetFieldHighlights();
        
        // Validasi tanggal submission
        const postingDateInput = document.getElementById("postingDate");
        if (!validateSubmissionDate(postingDateInput)) {
            Swal.fire({
                icon: 'error',
                title: 'Submission Date not valid',
                text: 'Please select today\'s date only. Past or future dates are not allowed.',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Validasi form reimbursement
        if (!validateReimbursementForm()) {
            return;
        }
        
        // Jika semua validasi lolos, panggil fungsi submit asli
        originalSubmitDocument();
    };
    </script>
    
    <script>
    // Fungsi untuk memformat angka dengan format Indonesia (titik sebagai pemisah ribuan, koma sebagai pemisah desimal)
    function formatCurrencyIDR(number) {
        // Handle input kosong atau tidak valid
        if (number === null || number === undefined || number === '') {
            return '0.00';
        }
        
        // Parse angka, pastikan dapat menangani nilai yang sangat besar
        let num;
        try {
            // Handle input string yang mungkin sangat besar
            if (typeof number === 'string') {
                // Hapus semua karakter non-numerik kecuali titik desimal dan koma
                const cleanedStr = number.replace(/[^\d,.]/g, '');
                // Gunakan parseFloat untuk angka kecil, dan untuk angka besar gunakan teknik string
                if (cleanedStr.length > 15) {
                    // Untuk angka yang sangat besar, kita perlu menangani dengan hati-hati
                    // Hapus koma dan parse
                    num = Number(cleanedStr.replace(/,/g, ''));
                } else {
                    num = parseFloat(cleanedStr.replace(/,/g, ''));
                }
            } else {
                num = Number(number); // Gunakan Number untuk menangani angka besar dengan lebih baik
            }
            
            // Jika parsing gagal, kembalikan string kosong
            if (isNaN(num)) {
                return '0.00';
            }
        } catch (e) {
            console.error('Error parsing number:', e);
            return '0.00';
        }
        
        // Batasi maksimum 100 triliun
        const maxAmount = 100000000000000; // 100 triliun
        if (num > maxAmount) {
            Swal.fire({
                icon: 'warning',
                title: 'Amount Exceeds Limit',
                text: 'Total amount must not exceed 100 trillion rupiah'
            });
            num = maxAmount;
        }
        
        // Format dengan format US (koma sebagai pemisah ribuan, titik sebagai pemisah desimal)
        // Untuk angka yang sangat besar, gunakan metode manual
        if (num >= 1e12) { // Jika angka >= 1 triliun
            let strNum = num.toString();
            let result = '';
            let count = 0;
            
            // Tambahkan koma setiap 3 digit dari belakang
            for (let i = strNum.length - 1; i >= 0; i--) {
                result = strNum[i] + result;
                count++;
                if (count % 3 === 0 && i > 0) {
                    result = ',' + result;
                }
            }
            
            // Tambahkan 2 desimal
            return result + '.00';
        } else {
            // Untuk angka yang lebih kecil, gunakan toLocaleString
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    }

    // Fungsi untuk mengurai format angka US kembali ke angka
    function parseCurrencyIDR(formattedValue) {
        if (!formattedValue) return 0;
        
        try {
            // Tangani format US (pemisah ribuan: ',', pemisah desimal: '.')
            // Hapus koma (pemisah ribuan)
            const numericValue = formattedValue.toString().replace(/,/g, '');
            
            return parseFloat(numericValue) || 0;
        } catch (e) {
            console.error('Error parsing currency:', e);
            return 0;
        }
    }

    // Fungsi untuk memformat input nilai mata uang saat pengguna mengetik
    function formatCurrencyInputIDR(input) {
        // Simpan posisi kursor
        const cursorPos = input.selectionStart;
        const originalLength = input.value.length;
        
        // Ambil nilai dan hapus semua karakter non-digit, titik dan koma
        let value = input.value.replace(/[^\d,.]/g, '');
        
        // Pastikan hanya ada satu pemisah desimal
        let parts = value.split('.');
        if (parts.length > 1) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Hapus batasan 10 digit
        // Tidak ada batasan panjang digit di sini
        
        // Parse nilai ke angka untuk perhitungan
        const numValue = parseCurrencyIDR(value);
        
        // Format dengan format US
        const formattedValue = formatCurrencyIDR(numValue);
        
        // Perbarui nilai input
        input.value = formattedValue;
        
        // Hitung dan perbarui total
        updateTotalAmount();
        
        // Sesuaikan posisi kursor
        const newLength = input.value.length;
        const newCursorPos = cursorPos + (newLength - originalLength);
        input.setSelectionRange(Math.max(0, newCursorPos), Math.max(0, newCursorPos));
    }

    // Fungsi untuk menghitung total amount dari semua baris
    function updateTotalAmount() {
        const amountInputs = document.querySelectorAll('#tableBody tr td:nth-child(5) input');
        let total = 0;
        
        amountInputs.forEach(input => {
            // Ekstrak nilai numerik dari input
            const amountText = input.value.trim();
            // Konversi dari format US ke format standar untuk perhitungan
            const numericValue = parseCurrencyIDR(amountText);
            total += numericValue;
        });
        
        // Periksa jika total melebihi 100 triliun
        const maxAmount = 100000000000000; // 100 triliun
        if (total > maxAmount) {
            Swal.fire({
                icon: 'warning',
                title: 'Amount Exceeds Limit',
                text: 'Total amount must not exceed 100 trillion rupiah'
            });
            total = maxAmount;
        }
        
        // Format total dengan format US dan tampilkan
        const formattedTotal = formatCurrencyIDR(total);
        
        // Tambahkan atau perbarui elemen untuk menampilkan total
        let totalContainer = document.querySelector('.total-amount-container');
        
        if (!totalContainer) {
            // Buat container total jika belum ada
            totalContainer = document.createElement('div');
            totalContainer.className = 'total-amount-container flex justify-end mt-4';
            
            const tableContainer = document.getElementById('reimTable').parentNode;
            tableContainer.insertBefore(totalContainer, document.querySelector('button[onclick="addRow()"]'));
            
            // Buat struktur HTML untuk total
            totalContainer.innerHTML = `
                <div class="w-1/3">
                    <div class="flex items-center">
                        <label class="font-semibold text-lg mr-4">Total Amount:</label>
                        <input type="text" id="totalAmount" class="w-full p-2 border rounded bg-gray-100 font-semibold text-right" readonly autocomplete="off">
                    </div>
                </div>
            `;
        }
        
        // Perbarui nilai total
        document.getElementById('totalAmount').value = formattedTotal;
    }

    // Modifikasi fungsi addRow untuk menggunakan format US
    function modifyAddRowForIDR() {
        const originalAddRow = window.addRow;
        
        window.addRow = function() {
            originalAddRow();
            
            // Ambil baris terakhir yang baru ditambahkan
            const tableBody = document.getElementById('tableBody');
            const newRow = tableBody.lastElementChild;
            
            // Ubah input untuk format IDR
            const amountInput = newRow.querySelector('td:nth-child(5) input');
            if (amountInput) {
                amountInput.type = 'text';
                amountInput.classList.add('currency-input-idr');
                amountInput.removeAttribute('maxlength'); // Hapus batasan maxlength jika ada
                amountInput.value = '0.00'; // Set nilai default
                amountInput.addEventListener('input', function() {
                    formatCurrencyInputIDR(this);
                });
                amountInput.setAttribute('autocomplete', 'off'); // Tambahkan autocomplete="off"
            }
        };
        
        // Ubah semua baris yang sudah ada
        const existingRows = document.querySelectorAll('#tableBody tr');
        existingRows.forEach(row => {
            const amountInput = row.querySelector('td:nth-child(5) input');
            if (amountInput) {
                amountInput.type = 'text';
                amountInput.classList.add('currency-input-idr');
                amountInput.addEventListener('input', function() {
                    formatCurrencyInputIDR(this);
                });
                amountInput.setAttribute('autocomplete', 'off'); // Tambahkan autocomplete="off"
                
                // Format nilai awal jika ada
                if (amountInput.value) {
                    formatCurrencyInputIDR(amountInput);
                } else {
                    amountInput.value = '0.00'; // Set nilai default jika kosong
                }
            }
        });
        
        // Inisialisasi total amount
        updateTotalAmount();
    }

    // Jalankan modifikasi setelah dokumen dimuat
    document.addEventListener('DOMContentLoaded', function() {
        // Hapus batasan maxlength dari input yang sudah ada
        const existingInputs = document.querySelectorAll('.currency-input-idr');
        existingInputs.forEach(input => {
            input.removeAttribute('maxlength');
            input.setAttribute('autocomplete', 'off'); // Tambahkan autocomplete="off"
            // Pastikan input memiliki nilai default
            if (!input.value) {
                input.value = '0.00';
            }
        });
        
        setTimeout(modifyAddRowForIDR, 500); // Delay sedikit untuk memastikan JS lain sudah dimuat
        
        // Inisialisasi total amount segera setelah halaman dimuat
        setTimeout(updateTotalAmount, 600);
        
        // Log untuk debugging
        console.log('Currency formatter initialized');
    });
    </script>
</body>
</html>